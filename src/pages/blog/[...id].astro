---
import Link from '@/components/Link.astro'
import PostHead from '@/components/PostHead.astro'
import SubpostsHeader from '@/components/SubpostsHeader.astro'
import TOCHeader from '@/components/TOCHeader.astro'
import { badgeVariants } from '@/components/ui/badge'
import Layout from '@/layouts/Layout.astro'
import {
  getAllPostsAndSubposts,
  getCombinedReadingTime,
  getParentId,
  getParentPost,
  getPostReadingTime,
  getSubpostCount,
  hasSubposts,
  isSubpost,
  parseAuthors,
} from '@/lib/data-utils'
import { formatDate, getTagVariant } from '@/lib/utils'
import { Image } from 'astro:assets'
import { render } from 'astro:content'

export async function getStaticPaths() {
  const posts = await getAllPostsAndSubposts()
  return posts.map((post) => ({
    params: { id: post.id },
    props: post,
  }))
}

const post = Astro.props
const currentPostId = Astro.params.id

// Error handling for content rendering
let Content: Awaited<ReturnType<typeof render>>['Content']
let headings: Awaited<ReturnType<typeof render>>['headings'] = []
try {
  const rendered = await render(post)
  Content = rendered.Content
  headings = rendered.headings ?? []
} catch (error) {
  console.error('Error rendering post content:', error)
  return Astro.redirect('/404')
}

// Error handling for authors parsing
let authors: Awaited<ReturnType<typeof parseAuthors>> = []
try {
  authors = await parseAuthors(post.data.authors ?? [])
} catch (error) {
  console.error('Error parsing authors:', error)
}

const isCurrentSubpost = isSubpost(currentPostId)

// Error handling for metadata
let parentPost: Awaited<ReturnType<typeof getParentPost>> = null
let hasChildPosts = false
let subpostCount = 0
let postReadingTime = '0 min read'
let combinedReadingTime: string | null = null

try {
  parentPost = isCurrentSubpost ? await getParentPost(currentPostId) : null
  hasChildPosts = await hasSubposts(currentPostId)
  subpostCount = !isCurrentSubpost ? await getSubpostCount(currentPostId) : 0
  postReadingTime = await getPostReadingTime(currentPostId)
  combinedReadingTime =
    hasChildPosts && !isCurrentSubpost
      ? await getCombinedReadingTime(currentPostId)
      : null
} catch (error) {
  console.error('Error fetching post metadata:', error)
}
---

<Layout>
  <PostHead slot="head" post={post} />
  {
    (hasChildPosts || isCurrentSubpost) && (
      <SubpostsHeader
        slot="subposts-navigation"
        parentId={isCurrentSubpost ? getParentId(currentPostId) : currentPostId}
      />
    )
  }
  {
    headings?.length > 0 &&
      !(
        isCurrentSubpost &&
        headings.length === 1 &&
        headings[0].text === post.data.title
      ) && <TOCHeader slot="table-of-contents" headings={headings} />
  }

  <section class="flex flex-col gap-4">
    {
      post.data.image && (
        <Image
          src={post.data.image}
          alt={post.data.title}
          width={1200}
          height={630}
          class="mx-auto w-full object-cover"
        />
      )
    }

    <section class="flex flex-col gap-4">
      <div class="flex flex-col gap-4">
        <h1
          class="scroll-mt-32 leading-tight font-semibold text-left"
          id="post-title"
        >
          {post.data.title}
        </h1>

        <div class="text-foreground/70 flex flex-wrap items-center gap-4">
          <span class="inline-flex items-center gap-1">
            <svg class="h-3.5 w-3.5 text-primary shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect>
              <line x1="16" x2="16" y1="2" y2="6"></line>
              <line x1="8" x2="8" y1="2" y2="6"></line>
              <line x1="3" x2="21" y1="10" y2="10"></line>
            </svg>
            {formatDate(post.data.date)}
          </span>
          <span class="text-foreground/50">路</span>
          <span class="inline-flex items-center gap-1">
            <svg class="h-3.5 w-3.5 text-primary shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            {postReadingTime}
          </span>
          {
            combinedReadingTime &&
              combinedReadingTime !== postReadingTime && (
                <>
                  <span class="text-foreground/50">路</span>
                  <span>{combinedReadingTime} total</span>
                </>
              )
          }
          {
            authors.length > 0 && (
              <>
                <span class="text-foreground/50">路</span>
                {authors.map((author) => (
                  author.isRegistered ? (
                    <Link
                      href={`/authors/${author.id}`}
                      underline
                      class="text-foreground"
                    >
                      <span>{author.name}</span>
                    </Link>
                  ) : (
                    <span>{author.name}</span>
                  )
                ))}
              </>
            )
          }
          {
            subpostCount > 0 && (
              <>
                <span class="text-foreground/50">路</span>
                <span>{subpostCount} subpost{subpostCount === 1 ? '' : 's'}</span>
              </>
            )
          }
        </div>
        <div class="flex flex-wrap justify-start gap-4">
          {
            post.data.tags &&
              post.data.tags.length > 0 &&
              post.data.tags.map((tag) => {
                const { variant, className, tooltip } = getTagVariant(tag)
                return (
                  <div class="group relative">
                    <a
                      href={`/tags/${tag}`}
                      class={`${badgeVariants({ variant })} ${className || ''}`}
                    >
                      <span class="text-foreground/70">#</span>
                      {tag}
                    </a>
                    {tooltip && (
                      <span class="pointer-events-none absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-max max-w-xs bg-gray-900 px-2 py-1 text-white shadow-xl border border-gray-700 invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-all duration-200 z-[100]">
                        {tooltip}
                        <span class="absolute left-1/2 -translate-x-1/2 top-full w-0 h-0 border-l-[6px] border-r-[6px] border-t-[6px] border-l-transparent border-r-transparent border-t-gray-900"></span>
                      </span>
                    )}
                  </div>
                )
              })
          }
        </div>
      </div>
    </section>

    <article class="prose max-w-none">
      <Content />
    </article>
  </section>

</Layout>

<script>
  if (document.querySelector('.katex')) {
    if (!document.querySelector('link[href*="katex.min.css"]')) {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href =
        'https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css'
      document.head.appendChild(link)
    }
  }
</script>
