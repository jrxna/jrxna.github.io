---
import {
  getCombinedReadingTime,
  getSubpostCount,
  isSubpost,
  parseAuthors,
} from '@/lib/data-utils'
import { formatDate } from '@/lib/utils'
import type { CollectionEntry } from 'astro:content'
import Link from './Link.astro'

interface Props {
  entry: CollectionEntry<'blog'>
}

const { entry } = Astro.props
const formattedDate = formatDate(entry.data.date)
const readTime = await getCombinedReadingTime(entry.id)
const authors = await parseAuthors(entry.data.authors ?? [])
const subpostCount = !isSubpost(entry.id) ? await getSubpostCount(entry.id) : 0
---

<Link
  href={`/${entry.collection}/${entry.id}`}
  class="group block p-4 border border-border transition-all duration-200 hover:bg-border/20"
>
  <div class="flex flex-col gap-2">
    <div class="flex items-baseline justify-between gap-4">
      <h3 class="font-semibold group-hover:text-foreground transition-colors">
        {entry.data.title}
      </h3>
    </div>
    <p class="text-foreground/70 line-clamp-1">
      {entry.data.description}
    </p>
    <div class="flex flex-wrap items-center gap-x-2 text-foreground/70">
      <span class="inline-flex items-center gap-1">
        <svg class="h-3.5 w-3.5 text-primary shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect>
          <line x1="16" x2="16" y1="2" y2="6"></line>
          <line x1="8" x2="8" y1="2" y2="6"></line>
          <line x1="3" x2="21" y1="10" y2="10"></line>
        </svg>
        {formattedDate}
      </span>
      <span class="text-foreground/50">·</span>
      <span class="inline-flex items-center gap-1">
        <svg class="h-3.5 w-3.5 text-primary shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        {readTime}
      </span>
      {
        authors.length > 0 && (
          <>
            <span class="text-foreground/50">·</span>
            <span class="font-medium">{authors.map(a => a.name).join(', ')}</span>
          </>
        )
      }
      {
        subpostCount > 0 && (
          <>
            <span class="text-foreground/50">·</span>
            <span>{subpostCount} subposts</span>
          </>
        )
      }
    </div>
  </div>
</Link>
